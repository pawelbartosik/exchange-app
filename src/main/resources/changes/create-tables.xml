<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="20240704-pawel-001" author="pawel">
        <sql>
            create table account
            (
                id      integer generated by default as identity
                    primary key,
                pesel   varchar(11) unique    not null,
                name    varchar(255)          not null,
                surname varchar(255)          not null,
                deleted boolean default false not null
            );
        </sql>
    </changeSet>
    <changeSet id="20240706-pawel-001" author="pawel">
        <sql>
            create table sub_account
            (
                id       integer generated by default as identity
                    primary key,
                pesel    varchar(11)    not null,
                currency varchar(3)     not null,
                amount   decimal(19, 2) not null,
                FOREIGN KEY (pesel) REFERENCES account (pesel)
            );
        </sql>
    </changeSet>
    <changeSet id="20240707-pawel-001" author="pawel">
        <sql>
            CREATE VIEW ACCOUNT_SUBACCOUNT_VIEW AS
            SELECT
                a.id,
                a.pesel,
                a.name,
                a.surname,
                STRING_AGG(s.currency || ' ' || CAST(s.amount AS VARCHAR), '; ') AS subaccounts_info
            FROM
                account a
                    LEFT JOIN
                sub_account s ON a.pesel = s.pesel
            GROUP BY
                a.id, a.pesel, a.name, a.surname
        </sql>
<!--        <sql>-->
<!--            create view EVENT_VIEW as-->
<!--            (-->
<!--            select e1_0.id,-->
<!--                   e1_0.date,-->
<!--                   e1_0.type,-->
<!--                   e1_0.price_per_person,-->
<!--                   e1_0.audience_capacity,-->
<!--                   e1_0.description,-->
<!--                   (select count(p1_0.id)-->
<!--                    from participant p1_0-->
<!--                             join event_participant e2_0 on p1_0.id = e2_0.participant_id-->
<!--                    where e2_0.event_id = e1_0.id) as number_of_participants-->
<!--            from event e1_0)-->
<!--        </sql>-->
    </changeSet>
</databaseChangeLog>